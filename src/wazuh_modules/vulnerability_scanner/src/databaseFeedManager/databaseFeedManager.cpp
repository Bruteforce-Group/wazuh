/*
 * Wazuh Vulnerability scanner - Database Feed Manager
 * Copyright (C) 2015, Wazuh Inc.
 * May 1, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "databaseFeedManager.hpp"
#include "../policyManager/policyManager.hpp"
#include "eventDecoder.hpp"
#include "scanDispatcher.hpp"
#include "storeModel.hpp"

DatabaseFeedManager::DatabaseFeedManager()
    : Observer("database_feed_manager")
{

    const auto updaterPolicy = PolicyManager::instance().getUpdaterConfiguration();
    // Vulnerability content updater initialization.
    m_contentRegistration = std::make_unique<ContentRegister>(updaterPolicy.at("topicName"),
                                                              PolicyManager::instance().getUpdaterConfiguration());

    // Subscription to vulnerability detector content update events.
    m_contentUpdateSubscription =
        std::make_unique<RouterSubscriber>(updaterPolicy.at("topicName"), "vulnerability_feed_manager");

    m_contentUpdateSubscription->subscribe(
        [](const std::vector<char>& message)
        {
            auto eventContext = std::make_shared<EventContext>();
            auto eventDecoder = std::make_shared<EventDecoder>();
            eventDecoder->setNext(std::make_shared<StoreModel>());
            eventDecoder->setNext(std::make_shared<FeedIndexer>());
            eventDecoder->setNext(std::make_shared<ScanDispatcher>());

            eventDecoder->handleRequest(eventContext);
        });
}

